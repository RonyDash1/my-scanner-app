<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-key="appTitle">QR Code Scanner & Barcode Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
        }
        body.dark {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            padding: 1.5rem; /* p-6 */
            width: 100%; /* Ensures it takes full width on small screens */
            max-width: 500px; /* Limits width on larger screens */
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.dark .container {
            background-color: #2d3748; /* Darker container */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        h1, h2 {
            color: #2d3748;
        }
        body.dark h1, body.dark h2 {
            color: #e2e8f0;
        }
        /* Video and Image Preview - designed to be responsive */
        video, #imagePreview {
            width: 100%; /* Ensures it takes full width of its container */
            max-width: 400px; /* Limits max width */
            height: auto; /* Maintains aspect ratio */
            border-radius: 0.75rem; /* rounded-lg */
            border: 2px solid #cbd5e0; /* border-gray-300 */
            margin-bottom: 1rem; /* mb-4 */
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        canvas {
            display: none; /* Canvas is used for processing, not direct display by default */
            position: absolute; /* Needed for QuaggaJS drawing overlay */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through */
        }
        /* Interactive viewport for QuaggaJS - responsive container */
        #interactive.viewport {
            position: relative; /* Container for video and canvas */
            width: 100%; /* Ensures it takes full width of its container */
            max-width: 400px; /* Limits max width */
            margin: 0 auto 1rem auto;
            border-radius: 0.75rem;
            border: 2px solid #cbd5e0;
            overflow: hidden; /* Hide overflow from canvas drawing */
        }
        #interactive.viewport video {
            position: relative;
            z-index: 1;
        }
        #interactive.viewport canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2; /* Draw over video */
        }

        #output, #geminiOutput, #historyList {
            background-color: #e2e8f0; /* bg-gray-200 */
            border-radius: 0.5rem; /* rounded-md */
            padding: 1rem; /* p-4 */
            min-height: 50px;
            word-wrap: break-word;
            text-align: left;
            font-size: 0.95rem; /* text-base */
            color: #2d3748; /* text-gray-800 */
            margin-top: 1rem; /* mt-4 */
        }
        body.dark #output, body.dark #historyList {
            background-color: #4a5568; /* Darker gray for output */
            color: #e2e8f0;
        }
        #geminiOutput {
            background-color: #e0f2fe; /* light blue for Gemini output */
            color: #0c4a6e; /* dark blue text */
            border: 1px solid #90cdf4;
        }
        body.dark #geminiOutput {
            background-color: #1e3a8a; /* Darker blue for Gemini output */
            color: #bfdbfe;
            border-color: #60a5fa;
        }
        .button {
            padding: 0.75rem 1.5rem; /* py-3 px-6 */
            border-radius: 0.75rem; /* rounded-xl */
            font-weight: 600; /* font-semibold */
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            display: inline-block;
            margin-top: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            background-image: linear-gradient(to right, #4f46e5, #6366f1); /* from-indigo-600 to-indigo-500 */
            color: white;
            border: none;
            margin-right: 0.5rem; /* Add some spacing between buttons */
            margin-left: 0.5rem;
        }
        .button:hover {
            background-image: linear-gradient(to right, #4338ca, #4f46e5); /* from-indigo-700 to-indigo-600 */
            transform: translateY(-2px);
        }
        .button:active {
            transform: translateY(0);
            box-shadow: none;
        }
        .button.secondary {
            background-image: linear-gradient(to right, #6b7280, #9ca3af);
        }
        .button.secondary:hover {
            background-image: linear-gradient(to right, #4b5563, #6b7280);
        }
        .button.danger {
            background-image: linear-gradient(to right, #dc2626, #ef4444);
        }
        .button.danger:hover {
            background-image: linear-gradient(to right, #b91c1c, #dc2626);
        }
        .error-message {
            color: #dc2626; /* text-red-600 */
            margin-top: 0.5rem;
            font-size: 0.875rem; /* text-sm */
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Button group uses flexbox for responsiveness */
        .button-group {
            display: flex;
            flex-wrap: wrap; /* Allows buttons to wrap to next line on small screens */
            justify-content: center;
            gap: 1rem; /* Space between buttons */
            margin-top: 1rem;
        }
        .section-header {
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600; /* font-semibold */
            color: #2d3748; /* text-gray-700 */
            margin-top: 2rem;
            margin-bottom: 1rem;
        }
        body.dark .section-header {
            color: #e2e8f0;
        }
        .input-group {
            margin-bottom: 1rem;
            text-align: left;
        }
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        body.dark .input-group label {
            color: #cbd5e0;
        }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #cbd5e0;
            background-color: #edf2f7;
            color: #2d3748;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }
        body.dark .input-group input, body.dark .input-group select, body.dark .input-group textarea {
            background-color: #4a5568;
            border-color: #6b7280;
            color: #e2e8f0;
        }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #historyList ul {
            list-style: none;
            padding: 0;
        }
        #historyList li {
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            display: flex; /* Use flexbox for alignment */
            align-items: center; /* Vertically align items */
        }
        body.dark #historyList li {
            background-color: #4a5568;
            color: #e2e8f0;
        }
        #historyList li:hover {
            background-color: #e2e8f0;
            transform: translateY(-1px);
        }
        body.dark #historyList li:hover {
            background-color: #6b7280;
        }
        #historyList li strong {
            color: #4f46e5;
        }
        body.dark #historyList li strong {
            color: #a78bfa;
        }
        #historyList li input[type="checkbox"] {
            margin-right: 0.75rem; /* Space between checkbox and text */
            transform: scale(1.2); /* Slightly larger checkbox */
            cursor: pointer;
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
        .history-text-content {
            flex-grow: 1; /* Allows text to take available space */
            word-break: break-all; /* Break long words */
            margin-right: 0.75rem; /* Space between text and favorite button */
        }
        .favorite-button {
            background: none;
            border: none;
            font-size: 1.5rem; /* Larger star icon */
            cursor: pointer;
            color: #cbd5e0; /* Default gray star */
            transition: color 0.2s ease, transform 0.1s ease;
            flex-shrink: 0; /* Prevent button from shrinking */
            padding: 0;
            line-height: 1;
        }
        .favorite-button.favorited {
            color: #facc15; /* Yellow star when favorited */
        }
        .favorite-button:hover {
            transform: scale(1.1);
        }
        .action-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .action-button {
            background-color: #3b82f6; /* Blue */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-decoration: none;
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            background-color: #2563eb;
        }
        .action-button.green {
            background-color: #10b981;
        }
        .action-button.green:hover {
            background-color: #059669;
        }
        .action-button.purple {
            background-color: #8b5cf6;
        }
        .action-button.purple:hover {
            background-color: #7c3aed;
        }

        /* Confirmation Modal Styles */
        #confirmationModal {
            background-color: rgba(0, 0, 0, 0.75);
        }
        #confirmationModal .bg-white {
            background-color: #ffffff;
        }
        body.dark #confirmationModal .bg-white {
            background-color: #2d3748;
        }
        #confirmationModal p {
            color: #2d3748;
        }
        body.dark #confirmationModal p {
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="container">
        <h1 class="text-3xl font-bold mb-6" data-key="appTitle">QR Code Scanner & Barcode Reader</h1>

        <div class="mb-4 text-right">
            <label for="languageSelect" class="sr-only" data-key="selectLanguage">Select Language</label>
            <select id="languageSelect" class="p-2 rounded-md bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 border border-gray-300 dark:border-gray-600">
                <option value="bn">বাংলা</option>
                <option value="en">English</option>
            </select>
        </div>

        <div class="button-group mb-6">
            <button id="showScannerButton" class="button" data-key="scannerTab">Scanner</button>
            <button id="showHistoryButton" class="button secondary" data-key="historyTab">History</button>
            <button id="darkModeToggle" class="button secondary" data-key="darkModeToggle">Dark Mode</button>
        </div>

        <div id="scannerSection">
            <div id="interactive" class="viewport">
                <video id="video" autoplay playsinline class="rounded-lg shadow-md"></video>
                <canvas class="drawingBuffer"></canvas> </div>
            <img id="imagePreview" class="rounded-lg shadow-md hidden" alt="Preview">
            <canvas id="canvas" class="hidden"></canvas> <div class="button-group">
                <button id="startQrScanButton" class="button" data-key="startQrScan">Start QR Scan</button>
                <button id="startBarcodeScanButton" class="button secondary" data-key="startBarcodeScan">Start Barcode Scan</button>
                <button id="stopButton" class="button hidden" data-key="stopCameraScan">Stop Camera Scan</button>
                <input type="file" id="imageUpload" accept="image/*" class="hidden">
                <button id="uploadButton" class="button" data-key="scanFromGallery">Scan from Gallery (QR Only)</button>
                <button id="flashlightButton" class="button secondary hidden" data-key="flashlight">Flashlight</button>
            </div>

            <div id="loading" class="loader"></div>
            <div id="errorMessage" class="error-message hidden"></div>

            <div class="mt-6">
                <h2 class="text-xl font-semibold mb-2" data-key="scannedInfo">Scanned Information:</h2>
                <div id="output" class="bg-gray-200 rounded-md p-4 break-words">
                    No QR code scanned yet.
                </div>
                <div id="actionButtons" class="action-buttons-container">
                    </div>
                <button id="explainButton" class="button hidden mt-4" data-key="explainInfo">✨ Explain Information</button>
            </div>

            <div id="geminiOutputContainer" class="mt-6 hidden">
                <h2 class="text-xl font-semibold mb-2" data-key="geminiExplanation">Explanation from Gemini:</h2>
                <div id="geminiOutput" class="rounded-md p-4 break-words">
                </div>
                <div id="geminiLoading" class="loader"></div>
                <div id="geminiErrorMessage" class="error-message hidden"></div>
            </div>
        </div>

        <div id="historySection" class="hidden">
            <h2 class="section-header" data-key="scanHistory">Scan History</h2>
            <div class="flex items-center justify-center mb-4">
                <input type="checkbox" id="showFavoritesCheckbox" class="mr-2 transform scale-125">
                <label for="showFavoritesCheckbox" data-key="showFavoritesOnly">Show Favorites Only</label>
            </div>
            <div id="historyList" class="bg-gray-200 rounded-md p-4">
                <ul>
                    </ul>
            </div>
            <div class="button-group">
                <button id="deleteSelectedHistoryButton" class="button danger hidden" data-key="deleteSelected">Delete Selected Items</button>
                <button id="clearHistoryButton" class="button danger" data-key="clearAllHistory">Clear All History</button>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="modalMessage" class="text-lg font-semibold text-gray-800 mb-4" data-key="confirm">Are you sure?</p>
            <div class="flex justify-center gap-4">
                <button id="confirmYes" class="button danger" data-key="yes">Yes</button>
                <button id="confirmNo" class="button secondary" data-key="no">No</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

    <script>
        // Language data
        const translations = {
            'bn': {
                'appTitle': 'QR কোড স্ক্যানার ও বারকোড রিডার', // Updated title
                'scannerTab': 'স্ক্যানার',
                'historyTab': 'ইতিহাস',
                'darkModeToggle': 'ডার্ক মোড',
                'lightModeToggle': 'লাইট মোড',
                'startQrScan': 'QR স্ক্যান শুরু করুন',
                'startBarcodeScan': 'বারকোড স্ক্যান শুরু করুন',
                'stopCameraScan': 'ক্যামেরা স্ক্যান বন্ধ করুন',
                'scanFromGallery': 'গ্যালারি থেকে ছবি আপলোড করুন (শুধুমাত্র QR)',
                'flashlight': 'ফ্ল্যাশলাইট',
                'scannedInfo': 'স্ক্যান করা তথ্য:',
                'noQrScanned': 'কোনো QR কোড স্ক্যান করা হয়নি।',
                'cameraStarting': 'ক্যামেরা চালু হচ্ছে...',
                'holdQrToScan': 'স্ক্যান করার জন্য QR কোড ধরুন...',
                'holdBarcodeToScan': 'স্ক্যান করার জন্য বারকোড ধরুন...',
                'cameraAccessError': 'ক্যামেরা অ্যাক্সেসের অনুমতি দেওয়া হয়নি। অনুগ্রহ করে ব্রাউজার সেটিংস (যেমন: Chrome-এর জন্য Settings > Privacy and security > Site Settings > Camera) থেকে এই সাইটের জন্য ক্যামেরা ব্যবহারের অনুমতি দিন। এছাড়াও, নিশ্চিত করুন আপনি একটি সুরক্ষিত (HTTPS) সংযোগে আছেন, কারণ ক্যামেরা ব্যবহারের জন্য HTTPS প্রয়োজন।',
                'noCameraFound': 'কোনো ক্যামেরা পাওয়া যায়নি। নিশ্চিত করুন আপনার ডিভাইসে একটি ক্যামেরা আছে এবং সেটি সঠিকভাবে কাজ করছে।',
                'cameraInUse': 'ক্যামেরা ব্যবহার করা যাচ্ছে না। অন্য কোনো অ্যাপ ক্যামেরা ব্যবহার করছে কিনা দেখুন এবং বন্ধ করে পুনরায় চেষ্টা করুন।',
                'unknownCameraError': 'ক্যামেরা চালু করতে সমস্যা হয়েছে:',
                'cameraNotStarted': 'ক্যামেরা চালু করা যায়নি।',
                'explainInfo': '✨ তথ্য ব্যাখ্যা করুন',
                'geminiExplanation': 'জেমিনি থেকে ব্যাখ্যা:',
                'geminiGenerating': 'জেমিনি ব্যাখ্যা তৈরি করছে...',
                'noInfoToExplain': 'ব্যাখ্যা করার জন্য কোনো তথ্য নেই।',
                'noGeminiExplanation': 'জেমিনি থেকে কোনো ব্যাখ্যা পাওয়া যায়নি।',
                'geminiCallError': 'জেমিনি API কল করতে সমস্যা হয়েছে:',
                'explanationNotLoaded': 'ব্যাখ্যা লোড করা যায়নি।',
                'loadingImage': 'ছবি লোড হচ্ছে...',
                'noQrInImage': 'এই ছবিতে কোনো QR কোড পাওয়া যায়নি।',
                'imageLoadError': 'ছবি লোড করতে সমস্যা হয়েছে।',
                'imageNotLoaded': 'ছবি লোড করা যায়নি।',
                'link': 'লিঙ্ক',
                'openLink': 'লিঙ্ক খুলুন',
                'phoneNumber': 'ফোন নম্বর',
                'call': 'কল করুন',
                'email': 'ইমেইল',
                'sendEmail': 'ইমেইল পাঠান',
                'smsNumber': 'SMS নম্বর',
                'message': 'বার্তা',
                'sendSms': 'SMS পাঠান',
                'wifiInfo': 'Wi-Fi নেটওয়ার্ক তথ্য:',
                'ssid': 'SSID (নেটওয়ার্ক নাম):',
                'encryption': 'এনক্রিপশন:',
                'password': 'পাসওয়ার্ড:',
                'noPassword': 'নেই',
                'wifiConnectHint': 'আপনি এই পাসওয়ার্ডটি ব্যবহার করে Wi-Fi এ কানেক্ট করতে পারবেন।',
                'location': 'লোকেশন',
                'viewOnMap': 'ম্যাপে দেখুন',
                'contactInfo': 'যোগাযোগের তথ্য (VCARD):',
                'name': 'নাম:',
                'phone': 'ফোন:',
                'eventInfo': 'ইভেন্টের তথ্য (VEVENT):',
                'summary': 'সারসংক্ষেপ:',
                'start': 'শুরু:',
                'end': 'শেষ:',
                'place': 'স্থান:',
                'addToContactsHint': 'আপনি এই তথ্যগুলো আপনার কন্টাক্ট লিস্টে যোগ করতে পারেন।',
                'addToCalendarHint': 'আপনি এই ইভেন্টটি আপনার ক্যালেন্ডারে যোগ করতে পারেন।',
                'scannerStopped': 'স্ক্যানার বন্ধ আছে।',
                'noFlashlightSupport': 'আপনার ডিভাইসে ফ্ল্যাশলাইট সমর্থিত নয়।',
                'flashlightOff': 'ফ্ল্যাশলাইট বন্ধ করুন',
                'flashlightOn': 'ফ্ল্যাশলাইট চালু করুন',
                'noCameraActiveFlashlight': 'ক্যামেরা চালু নেই বা ফ্ল্যাশলাইট সমর্থিত নয়।',
                'barcodeScannerError': 'বারকোড স্ক্যানার চালু করতে সমস্যা হয়েছে',
                'initialScannerPrompt': 'ক্যামেরা ব্যবহার করে স্ক্যান করুন (QR বা বারকোড) অথবা গ্যালারি থেকে ছবি আপলোড করুন (শুধুমাত্র QR)।',

                // History Section
                'scanHistory': 'স্ক্যান ইতিহাস',
                'noScanHistory': 'কোনো স্ক্যান ইতিহাস নেই।',
                'deleteSelected': 'নির্বাচিত আইটেম মুছে ফেলুন',
                'clearAllHistory': 'সমস্ত ইতিহাস মুছে ফেলুন',
                'confirmDeleteAll': 'আপনি কি নিশ্চিত যে আপনি সমস্ত স্ক্যান ইতিহাস মুছে ফেলতে চান?',
                'confirmDeleteSelected': 'আপনি কি নিশ্চিত যে আপনি নির্বাচিত {count}টি আইটেম মুছে ফেলতে চান?',
                'noItemSelected': 'মুছে ফেলার জন্য কোনো আইটেম নির্বাচন করা হয়নি।',
                'favorite': 'ফেভারিট',
                'unfavorite': 'ফেভারিট নয়',
                'showFavoritesOnly': 'শুধুমাত্র ফেভারিট দেখান',
                'noFavoriteItems': 'কোনো ফেভারিট আইটেম নেই।',

                // General
                'yes': 'হ্যাঁ',
                'no': 'না',
                'confirm': 'আপনি কি নিশ্চিত?',
                'ok': 'ঠিক আছে',
            },
            'en': {
                'appTitle': 'QR Code Scanner & Barcode Reader', // Updated title
                'scannerTab': 'Scanner',
                'historyTab': 'History',
                'darkModeToggle': 'Dark Mode',
                'lightModeToggle': 'Light Mode',
                'startQrScan': 'Start QR Scan',
                'startBarcodeScan': 'Start Barcode Scan',
                'stopCameraScan': 'Stop Camera Scan',
                'scanFromGallery': 'Scan from Gallery (QR Only)',
                'flashlight': 'Flashlight',
                'scannedInfo': 'Scanned Information:',
                'noQrScanned': 'No QR code scanned yet.',
                'cameraStarting': 'Starting camera...',
                'holdQrToScan': 'Hold QR code to scan...',
                'holdBarcodeToScan': 'Hold barcode to scan...',
                'cameraAccessError': 'Camera access denied. Please allow camera usage for this site in your browser settings (e.g., for Chrome: Settings > Privacy and security > Site Settings > Camera). Also, ensure you are on a secure (HTTPS) connection, as HTTPS is required for camera access.',
                'noCameraFound': 'No camera found. Make sure your device has a camera and it is working correctly.',
                'cameraInUse': 'Camera is in use. Check if another app is using the camera and close it, then try again.',
                'unknownCameraError': 'Failed to start camera:',
                'cameraNotStarted': 'Camera could not be started.',
                'explainInfo': '✨ Explain Information',
                'geminiExplanation': 'Explanation from Gemini:',
                'geminiGenerating': 'Gemini is generating explanation...',
                'noInfoToExplain': 'No information to explain.',
                'noGeminiExplanation': 'No explanation found from Gemini.',
                'geminiCallError': 'Error calling Gemini API:',
                'explanationNotLoaded': 'Explanation could not be loaded.',
                'loadingImage': 'Loading image...',
                'noQrInImage': 'No QR code found in this image.',
                'imageLoadError': 'Error loading image.',
                'imageNotLoaded': 'Image could not be loaded.',
                'link': 'Link',
                'openLink': 'Open Link',
                'phoneNumber': 'Phone Number',
                'call': 'Call',
                'email': 'Email',
                'sendEmail': 'Send Email',
                'smsNumber': 'SMS Number',
                'message': 'Message',
                'sendSms': 'Send SMS',
                'wifiInfo': 'Wi-Fi Network Information:',
                'ssid': 'SSID (Network Name):',
                'encryption': 'Encryption:',
                'password': 'Password:',
                'noPassword': 'None',
                'wifiConnectHint': 'You can use this password to connect to the Wi-Fi.',
                'location': 'Location',
                'viewOnMap': 'View on Map',
                'contactInfo': 'Contact Information (VCARD):',
                'name': 'Name:',
                'phone': 'Phone:',
                'eventInfo': 'Event Information (VEVENT):',
                'summary': 'Summary:',
                'start': 'Start:',
                'end': 'End:',
                'place': 'Place:',
                'addToContactsHint': 'You can add this information to your contacts list.',
                'addToCalendarHint': 'You can add this event to your calendar.',
                'scannerStopped': 'Scanner is stopped.',
                'noFlashlightSupport': 'Flashlight is not supported on your device.',
                'flashlightOff': 'Turn Flashlight Off',
                'flashlightOn': 'Turn Flashlight On',
                'noCameraActiveFlashlight': 'Camera is not active or flashlight is not supported.',
                'barcodeScannerError': 'Failed to start barcode scanner',
                'initialScannerPrompt': 'Scan using camera (QR or Barcode) or upload image from gallery (QR Only).',

                // History Section
                'scanHistory': 'Scan History',
                'noScanHistory': 'No scan history yet.',
                'deleteSelected': 'Delete Selected Items',
                'clearAllHistory': 'Clear All History',
                'confirmDeleteAll': 'Are you sure you want to delete all scan history?',
                'confirmDeleteSelected': 'Are you sure you want to delete the selected {count} items?',
                'noItemSelected': 'No items selected for deletion.',
                'favorite': 'Favorite',
                'unfavorite': 'Unfavorite',
                'showFavoritesOnly': 'Show Favorites Only',
                'noFavoriteItems': 'No favorite items.',

                // General
                'yes': 'Yes',
                'no': 'No',
                'confirm': 'Are you sure?',
                'ok': 'OK',
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'en'; // Default to English

        // Function to set the language
        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang; // Set HTML lang attribute

            // Update all elements with data-key
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.dataset.key;
                if (translations[currentLanguage][key]) {
                    if (element.tagName === 'INPUT' && (element.type === 'text' || element.type === 'url' || element.type === 'tel' || element.type === 'email')) {
                        element.placeholder = translations[currentLanguage][key];
                    } else if (element.tagName === 'TEXTAREA') {
                        element.placeholder = translations[currentLanguage][key];
                    } else if (element.tagName === 'OPTION') {
                        // For options, update text content if data-key is present
                        // Ensure that options that are not directly translated by data-key (like WPA, WEP) remain unchanged
                        if (element.dataset.key) { // Only translate if data-key is explicitly set on option
                            element.textContent = translations[currentLanguage][key];
                        }
                    }
                    else {
                        element.textContent = translations[currentLanguage][key];
                    }
                }
            });

            // Special handling for flashlight button text
            if (currentTrack && currentTrack.getSettings().torch) {
                flashlightButton.textContent = translations[currentLanguage]['flashlightOff'];
            } else {
                flashlightButton.textContent = translations[currentLanguage]['flashlightOn'];
            }

            // Update specific messages that are not directly mapped to data-key
            updateDynamicMessages();
            renderHistory(); // Re-render history with new language
            updateDeleteSelectedButtonState(); // Update text for delete selected button
        }

        // Function to update dynamic messages (e.g., initial output, error messages)
        function updateDynamicMessages() {
            // Update initial prompt for scanner
            if (scannerSection.classList.contains('hidden') === false) { // Only update if scanner is visible
                if (activeScanMode === 'qr' && isScanning) {
                    outputDiv.textContent = translations[currentLanguage]['holdQrToScan'];
                } else if (activeScanMode === 'barcode' && QuaggaInitialized) {
                    outputDiv.textContent = translations[currentLanguage]['holdBarcodeToScan'];
                } else if (video.srcObject) { // If camera is active but not scanning (e.g., just started)
                    outputDiv.textContent = translations[currentLanguage]['cameraStarting'];
                } else { // Initial state or after stopping camera
                    outputDiv.textContent = translations[currentLanguage]['initialScannerPrompt'];
                }
            }
            // All generator placeholders removed as the generator section is removed.
        }


        // DOM Elements
        const video = document.getElementById('video');
        const imagePreview = document.getElementById('imagePreview');
        const canvas = document.getElementById('canvas'); // Used by jsQR
        const outputDiv = document.getElementById('output');
        const startQrScanButton = document.getElementById('startQrScanButton'); // Renamed from startButton
        const startBarcodeScanButton = document.getElementById('startBarcodeScanButton'); // New button
        const stopButton = document.getElementById('stopButton');
        const uploadButton = document.getElementById('uploadButton');
        const imageUpload = document.getElementById('imageUpload');
        const loadingDiv = document.getElementById('loading');
        const errorMessageDiv = document.getElementById('errorMessage');
        const ctx = canvas.getContext('2d');
        const actionButtonsContainer = document.getElementById('actionButtons');
        const interactiveViewport = document.getElementById('interactive'); // For QuaggaJS

        // Gemini API related elements
        const explainButton = document.getElementById('explainButton');
        const geminiOutputContainer = document.getElementById('geminiOutputContainer');
        const geminiOutput = document.getElementById('geminiOutput');
        const geminiLoading = document.getElementById('geminiLoading');
        const geminiErrorMessage = document.getElementById('geminiErrorMessage');

        // Navigation buttons
        const showScannerButton = document.getElementById('showScannerButton');
        // const showGeneratorButton = document.getElementById('showGeneratorButton'); // REMOVED
        const showHistoryButton = document.getElementById('showHistoryButton');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const languageSelect = document.getElementById('languageSelect'); // Language selector

        // Sections
        const scannerSection = document.getElementById('scannerSection');
        // const generatorSection = document.getElementById('generatorSection'); // REMOVED
        const historySection = document.getElementById('historySection');

        // History elements
        const historyListUl = document.querySelector('#historyList ul');
        const clearHistoryButton = document.getElementById('clearHistoryButton');
        const deleteSelectedHistoryButton = document.getElementById('deleteSelectedHistoryButton');
        const showFavoritesCheckbox = document.getElementById('showFavoritesCheckbox'); // New favorite checkbox

        // Flashlight button
        const flashlightButton = document.getElementById('flashlightButton');

        // Confirmation Modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const modalMessage = document.getElementById('modalMessage');
        const confirmYesButton = document.getElementById('confirmYes');
        const confirmNoButton = document.getElementById('confirmNo');

        // Global variables
        let stream;
        let animationFrameId; // For jsQR loop
        let isScanning = false; // For jsQR loop
        let activeScanMode = null; // 'qr' or 'barcode'
        let lastScannedData = '';
        let currentTrack = null; // To manage camera track for flashlight
        let onConfirmCallback = null; // To store the callback function for the modal
        let selectedHistoryIndices = new Set(); // To store indices of selected history items
        let QuaggaInitialized = false; // Custom flag to track Quagga state

        // --- UI State Management ---
        function showSection(sectionId) {
            scannerSection.classList.add('hidden');
            // generatorSection.classList.add('hidden'); // REMOVED
            historySection.classList.add('hidden');

            document.getElementById(sectionId).classList.remove('hidden');

            // Reset active button styles
            showScannerButton.classList.add('secondary');
            // showGeneratorButton.classList.add('secondary'); // REMOVED
            showHistoryButton.classList.add('secondary');

            if (sectionId === 'scannerSection') {
                showScannerButton.classList.remove('secondary');
                resetUI(); // Reset scanner UI when navigating to it
            } else if (sectionId === 'historySection') {
                showHistoryButton.classList.remove('secondary');
                stopScanner(); // Stop camera if active
                renderHistory();
            }
            // else if (sectionId === 'generatorSection') { // REMOVED
            //     showGeneratorButton.classList.remove('secondary');
            //     stopScanner();
            //     resetGeneratorUI();
            // }
        }

        // UI স্টেট রিসেট করার ফাংশন
        function resetUI() {
            stopScanner(); // Stop camera if active
            interactiveViewport.classList.remove('hidden'); // Ensure viewport is visible
            video.style.display = 'block'; // Ensure video is visible
            imagePreview.style.display = 'none';
            imagePreview.src = ''; // Clear image preview
            canvas.style.display = 'none'; // Hide jsQR canvas
            outputDiv.textContent = translations[currentLanguage]['noQrScanned']; // Initial message for scanner
            actionButtonsContainer.innerHTML = ''; // Clear action buttons
            explainButton.classList.add('hidden');
            geminiOutputContainer.classList.add('hidden');
            geminiOutput.textContent = '';
            loadingDiv.style.display = 'none';
            errorMessageDiv.classList.add('hidden');
            geminiLoading.style.display = 'none';
            geminiErrorMessage.classList.add('hidden');
            startQrScanButton.classList.remove('hidden'); // Show QR scan button
            startBarcodeScanButton.classList.remove('hidden'); // Show Barcode scan button
            stopButton.classList.add('hidden'); // Hide stop button
            flashlightButton.classList.add('hidden'); // Hide flashlight button
            updateDynamicMessages(); // Ensure initial messages are translated
        }

        // জেনারেটর UI রিসেট করার ফাংশন - REMOVED
        // function resetGeneratorUI() { ... }


        // --- Camera and Scanning Logic ---
        async function startScanner(mode) {
            resetUI(); // Reset UI
            activeScanMode = mode;
            interactiveViewport.classList.remove('hidden'); // Ensure viewport is visible
            video.style.display = 'block'; // Ensure video is visible

            // Hide initial start buttons
            startQrScanButton.classList.add('hidden');
            startBarcodeScanButton.classList.add('hidden');
            stopButton.classList.remove('hidden'); // Show stop button

            try {
                loadingDiv.style.display = 'block'; // Show loading spinner
                outputDiv.textContent = translations[currentLanguage]['cameraStarting'];

                // Request camera access
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                currentTrack = stream.getVideoTracks()[0]; // Save track for flashlight

                // Show flashlight button if supported
                const capabilities = currentTrack.getCapabilities();
                if (capabilities.torch) {
                    flashlightButton.classList.remove('hidden');
                } else {
                    flashlightButton.classList.add('hidden');
                }

                video.setAttribute('playsinline', true); // For iOS video playback
                await video.play();

                // Once video metadata is loaded, start the specific scanner mode
                video.addEventListener('loadedmetadata', () => {
                    // Set canvas size for jsQR or prepare QuaggaJS
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;

                    if (activeScanMode === 'qr') {
                        isScanning = true;
                        canvas.style.display = 'none'; // jsQR uses it internally
                        scanQRCode(); // Start jsQR loop
                        outputDiv.textContent = translations[currentLanguage]['holdQrToScan'];
                    } else if (activeScanMode === 'barcode') {
                        canvas.style.display = 'block'; // QuaggaJS draws on this canvas
                        initQuagga(); // Initialize and start QuaggaJS
                        outputDiv.textContent = translations[currentLanguage]['holdBarcodeToScan'];
                    }

                    loadingDiv.style.display = 'none'; // Hide loading spinner
                }, { once: true }); // Event listener runs once
            } catch (err) {
                console.error("Error accessing camera:", err);
                loadingDiv.style.display = 'none'; // Hide loading spinner
                errorMessageDiv.classList.remove('hidden'); // Show error message
                if (err.name === 'NotAllowedError') {
                    errorMessageDiv.textContent = translations[currentLanguage]['cameraAccessError'];
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                    errorMessageDiv.textContent = translations[currentLanguage]['noCameraFound'];
                } else if (err.name === 'NotReadableError') {
                    errorMessageDiv.textContent = translations[currentLanguage]['cameraInUse'];
                } else {
                    errorMessageDiv.textContent = `${translations[currentLanguage]['unknownCameraError']} ${err.message || 'Unknown Error'}`;
                }
                outputDiv.textContent = translations[currentLanguage]['cameraNotStarted'];
                explainButton.classList.add('hidden');
                geminiOutputContainer.classList.add('hidden');
                flashlightButton.classList.add('hidden');
                activeScanMode = null; // Reset mode on error
                // Show initial start buttons again
                startQrScanButton.classList.remove('hidden');
                startBarcodeScanButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
            }
        }

        // QR code scanning loop (for QR mode)
        function scanQRCode() {
            if (video.readyState === video.HAVE_ENOUGH_DATA && isScanning && activeScanMode === 'qr') {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height, {
                    inversionAttempts: "dontInvert",
                });

                // Detect QR code
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    handleScannedData(code.data);
                    saveScanToHistory(code.data);
                    stopScanner(); // Stop scanner after successful scan
                } else {
                    outputDiv.textContent = translations[currentLanguage]['holdQrToScan'];
                    actionButtonsContainer.innerHTML = '';
                    explainButton.classList.add('hidden');
                    geminiOutputContainer.classList.add('hidden');
                    geminiOutput.textContent = '';
                }
            }
            animationFrameId = requestAnimationFrame(scanQRCode);
        }

        // Initialize and start QuaggaJS for barcode scanning
        function initQuagga() {
            if (typeof Quagga === 'undefined') {
                errorMessageDiv.classList.remove('hidden');
                errorMessageDiv.textContent = translations[currentLanguage]['barcodeScannerError'] + ': QuaggaJS library not loaded.';
                stopScanner();
                return;
            }

            // Hide jsQR canvas, QuaggaJS will draw on its own drawingBuffer canvas
            canvas.style.display = 'none';
            // Ensure Quagga's drawingBuffer canvas is visible if it exists
            const quaggaDrawingCanvas = document.querySelector('#interactive .drawingBuffer');
            if (quaggaDrawingCanvas) {
                quaggaDrawingCanvas.style.display = 'block';
            }

            Quagga.init({
                inputStream : {
                    name : "Live",
                    type : "LiveStream",
                    target: video, // Use the video element as the input source
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment",
                        aspectRatio: { min: 1, max: 2 }
                    }
                },
                decoder : {
                    readers : [
                        "code_128_reader",
                        "ean_reader",
                        "ean_8_reader",
                        "code_39_reader",
                        "codabar_reader",
                        "upc_reader",
                        "upc_e_reader",
                        "i2of5_reader",
                        "2of5_reader",
                        "code_93_reader"
                    ],
                    debug: {
                        showCanvas: true, // Quagga will draw on its own canvas
                        showPatches: false,
                        showFoundPatches: false,
                        showSkeleton: false,
                        showLabels: false,
                        showPatchLabels: false,
                        showRemainingPatchLabels: false,
                        boxFromPatches: {
                            showTransformed: false,
                            showTransformedPatch: false,
                            showPatch: false
                        },
                        showBoundingBox: true // Show bounding box for detected code
                    }
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true
                },
                numOfWorkers: navigator.hardwareConcurrency || 2,
                locate: true
            }, function(err) {
                if (err) {
                    console.error(err);
                    errorMessageDiv.classList.remove('hidden');
                    errorMessageDiv.textContent = `${translations[currentLanguage]['barcodeScannerError']}: ${err.message || 'Unknown error'}`;
                    stopScanner();
                    return;
                }
                console.log("QuaggaJS initialization finished. Ready to start");
                Quagga.start();
                QuaggaInitialized = true;
                outputDiv.textContent = translations[currentLanguage]['holdBarcodeToScan'];
            });

            Quagga.onDetected(function(result) {
                if (result.codeResult) {
                    const barcodeData = result.codeResult.code;
                    handleScannedData(barcodeData);
                    saveScanToHistory(barcodeData);
                    stopScanner(); // Stop after first successful scan
                }
            });

            Quagga.onProcessed(function(result) {
                // This callback is used by Quagga to draw on its own canvas
                // We don't need to manually draw here unless we want custom drawing.
                // Quagga's debug.showBoundingBox: true handles drawing the box.
            });
        }

        // Function to stop scanner
        function stopScanner() {
            isScanning = false; // For jsQR loop
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }

            if (activeScanMode === 'barcode' && typeof Quagga !== 'undefined' && QuaggaInitialized) {
                Quagga.stop();
                QuaggaInitialized = false;
                // Hide Quagga's drawing canvas
                const quaggaDrawingCanvas = document.querySelector('#interactive .drawingBuffer');
                if (quaggaDrawingCanvas) {
                    quaggaDrawingCanvas.style.display = 'none';
                    const quaggaCtx = quaggaDrawingCanvas.getContext('2d');
                    quaggaCtx.clearRect(0, 0, quaggaDrawingCanvas.width, quaggaDrawingCanvas.height); // Clear drawings
                }
            }

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            // Reset buttons and UI messages
            startQrScanButton.classList.remove('hidden');
            startBarcodeScanButton.classList.remove('hidden');
            stopButton.classList.add('hidden');
            flashlightButton.classList.add('hidden');
            currentTrack = null;
            activeScanMode = null;
            outputDiv.textContent = translations[currentLanguage]['scannerStopped']; // Or initial prompt
            updateDynamicMessages(); // To show initial prompt
        }

        // Function to scan image from gallery (QR only)
        async function scanFromImage(event) {
            resetUI();
            video.style.display = 'none'; // Hide video
            interactiveViewport.classList.add('hidden'); // Hide viewport for image preview
            imagePreview.style.display = 'block'; // Show image preview
            canvas.style.display = 'block'; // Make jsQR canvas visible for image processing

            const file = event.target.files[0];
            if (!file) {
                return;
            }

            loadingDiv.style.display = 'block';
            outputDiv.textContent = translations[currentLanguage]['loadingImage'];

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    imagePreview.src = img.src; // Show image in preview

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });

                    loadingDiv.style.display = 'none';
                    if (code) {
                        handleScannedData(code.data);
                        saveScanToHistory(code.data);
                    } else {
                        outputDiv.textContent = translations[currentLanguage]['noQrInImage'];
                        actionButtonsContainer.innerHTML = '';
                        explainButton.classList.add('hidden');
                        geminiOutputContainer.classList.add('hidden');
                        geminiOutput.textContent = '';
                    }
                    canvas.style.display = 'none'; // Hide canvas after processing
                };
                img.onerror = () => {
                    loadingDiv.style.display = 'none';
                    errorMessageDiv.classList.remove('hidden');
                    errorMessageDiv.textContent = translations[currentLanguage]['imageLoadError'];
                    outputDiv.textContent = translations[currentLanguage]['imageNotLoaded'];
                    actionButtonsContainer.innerHTML = '';
                    explainButton.classList.add('hidden');
                    geminiOutputContainer.classList.add('hidden');
                    geminiOutput.textContent = '';
                    canvas.style.display = 'none'; // Hide canvas on error
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Function to handle scanned data (with different formats and action buttons)
        function handleScannedData(data) {
            lastScannedData = data; // Save data for Gemini
            let displayHtml = '';
            actionButtonsContainer.innerHTML = ''; // Clear previous buttons

            // Function to add action button
            const addActionButton = (text, className, href) => {
                const button = document.createElement('a');
                button.href = href;
                button.target = '_blank'; // Open in new tab for safety
                button.className = `action-button ${className}`;
                button.textContent = text;
                actionButtonsContainer.appendChild(button);
            };

            if (data.startsWith('http://') || data.startsWith('https://')) {
                displayHtml = `<p><strong>${translations[currentLanguage]['link']}:</strong> <a href="${data}" target="_blank" class="text-blue-600 hover:underline">${data}</a></p>`;
                addActionButton(translations[currentLanguage]['openLink'], 'blue', data);
            } else if (data.startsWith('tel:')) {
                const phoneNumber = data.substring(4);
                displayHtml = `<p><strong>${translations[currentLanguage]['phoneNumber']}:</strong> <a href="${data}" class="text-blue-600 hover:underline">${phoneNumber}</a></p>`;
                addActionButton(translations[currentLanguage]['call'], 'green', data);
            } else if (data.startsWith('mailto:')) {
                const emailAddress = data.substring(7).split('?')[0];
                displayHtml = `<p><strong>${translations[currentLanguage]['email']}:</strong> <a href="${data}" class="text-blue-600 hover:underline">${emailAddress}</a></p>`;
                addActionButton(translations[currentLanguage]['sendEmail'], 'purple', data);
            } else if (data.startsWith('SMS:')) {
                const parts = data.substring(4).split(':');
                const number = parts[0];
                const message = parts[1] || '';
                displayHtml = `<p><strong>${translations[currentLanguage]['smsNumber']}:</strong> ${number}</p><p><strong>${translations[currentLanguage]['message']}:</strong> ${message}</p>`;
                addActionButton(translations[currentLanguage]['sendSms'], 'blue', data);
            } else if (data.startsWith('WIFI:')) {
                const parts = data.substring(5).split(';');
                let ssid = '';
                let password = '';
                let encryption = '';

                parts.forEach(part => {
                    if (part.startsWith('S:')) { ssid = part.substring(2); }
                    else if (part.startsWith('P:')) { password = part.substring(2); }
                    else if (part.startsWith('T:')) { encryption = part.substring(2); }
                });

                displayHtml = `
                    <p class="font-bold text-lg mb-2">${translations[currentLanguage]['wifiInfo']}</p>
                    <p><strong>${translations[currentLanguage]['ssid']}</strong> ${ssid || translations[currentLanguage]['noPassword']}</p>
                    <p><strong>${translations[currentLanguage]['encryption']}:</strong> ${encryption || translations[currentLanguage]['noPassword']}</p>
                    <p><strong>${translations[currentLanguage]['password']}:</strong> <span class="text-green-700 font-bold">${password || translations[currentLanguage]['noPassword']}</span></p>
                    <p class="mt-2 text-sm text-gray-600">${translations[currentLanguage]['wifiConnectHint']}</p>
                `;
            } else if (data.startsWith('geo:')) {
                const coords = data.substring(4).split('?')[0];
                displayHtml = `<p><strong>${translations[currentLanguage]['location']}:</strong> <a href="https://www.google.com/maps/search/?api=1&query=${coords}" target="_blank" class="text-blue-600 hover:underline">${coords}</a></p>`;
                addActionButton(translations[currentLanguage]['viewOnMap'], 'blue', `https://www.google.com/maps/search/?api=1&query=${coords}`); // Fixed the URL for Google Maps
            } else if (data.startsWith('BEGIN:VCARD')) {
                // Basic VCARD parsing
                const nameMatch = data.match(/FN:(.*?)\n/);
                const telMatch = data.match(/TEL:(.*?)\n/);
                const emailMatch = data.match(/EMAIL:(.*?)\n/);

                const name = nameMatch ? nameMatch[1] : translations[currentLanguage]['noPassword'];
                const tel = telMatch ? telMatch[1] : translations[currentLanguage]['noPassword'];
                const email = emailMatch ? emailMatch[1] : translations[currentLanguage]['noPassword'];

                displayHtml = `
                    <p class="font-bold text-lg mb-2">${translations[currentLanguage]['contactInfo']}</p>
                    <p><strong>${translations[currentLanguage]['name']}</strong> ${name}</p>
                    <p><strong>${translations[currentLanguage]['phone']}</strong> ${tel}</p>
                    <p><strong>${translations[currentLanguage]['email']}:</strong> ${email}</p>
                    <p class="mt-2 text-sm text-gray-600">${translations[currentLanguage]['addToContactsHint']}</p>
                `;
            } else if (data.startsWith('BEGIN:VEVENT')) {
                // Basic VEVENT parsing
                const summaryMatch = data.match(/SUMMARY:(.*?)\n/);
                const startMatch = data.match(/DTSTART:(.*?)\n/);
                const endMatch = data.match(/DTEND:(.*?)\n/);
                const locationMatch = data.match(/LOCATION:(.*?)\n/);

                const summary = summaryMatch ? summaryMatch[1] : translations[currentLanguage]['noPassword'];
                const start = startMatch ? new Date(startMatch[1]).toLocaleString(currentLanguage) : translations[currentLanguage]['noPassword'];
                const end = endMatch ? new Date(endMatch[1]).toLocaleString(currentLanguage) : translations[currentLanguage]['noPassword'];
                const location = locationMatch ? locationMatch[1] : translations[currentLanguage]['noPassword'];

                displayHtml = `
                    <p class="font-bold text-lg mb-2">${translations[currentLanguage]['eventInfo']}</p>
                    <p><strong>${translations[currentLanguage]['summary']}</strong> ${summary}</p>
                    <p><strong>${translations[currentLanguage]['start']}</strong> ${start}</p>
                    <p><strong>${translations[currentLanguage]['end']}</strong> ${end}</p>
                    <p><strong>${translations[currentLanguage]['place']}</strong> ${location}</p>
                    <p class="mt-2 text-sm text-gray-600">${translations[currentLanguage]['addToCalendarHint']}</p>
                `;
            }
            else {
                // Default to plain text
                displayHtml = `<p><strong>${translations[currentLanguage]['scannedInfo']}</strong> ${data}</p>`;
            }

            outputDiv.innerHTML = displayHtml;
            explainButton.classList.remove('hidden');
            geminiOutputContainer.classList.add('hidden');
            geminiOutput.textContent = '';
        }

        // --- Gemini API Logic ---
        async function explainWithGemini() {
            if (!lastScannedData || lastScannedData === translations[currentLanguage]['noQrScanned'] || lastScannedData === translations[currentLanguage]['holdQrToScan'] || lastScannedData === translations[currentLanguage]['holdBarcodeToScan']) {
                geminiErrorMessage.textContent = translations[currentLanguage]['noInfoToExplain'];
                geminiErrorMessage.classList.remove('hidden');
                return;
            }

            geminiOutputContainer.classList.remove('hidden');
            geminiOutput.textContent = translations[currentLanguage]['geminiGenerating'];
            geminiLoading.style.display = 'block';
            geminiErrorMessage.classList.add('hidden');

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: `Explain this scanned QR code information and its relevance: "${lastScannedData}" in ${currentLanguage === 'bn' ? 'Bengali' : 'English'}.` }] });

            const payload = { contents: chatHistory };
            const apiKey = ""; // Canvas runtime will provide API key
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    geminiOutput.textContent = text;
                } else {
                    geminiOutput.textContent = translations[currentLanguage]['noGeminiExplanation'];
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                geminiErrorMessage.textContent = `${translations[currentLanguage]['geminiCallError']} ${error.message}`;
                geminiErrorMessage.classList.remove('hidden');
                geminiOutput.textContent = translations[currentLanguage]['explanationNotLoaded'];
            } finally {
                geminiLoading.style.display = 'none';
            }
        }

        // --- History Feature Logic ---
        function saveScanToHistory(data) {
            let history = JSON.parse(localStorage.getItem('qr_history') || '[]');
            const timestamp = new Date().toLocaleString(currentLanguage);
            // Add isFavorite property, default to false
            history.unshift({ data: data, timestamp: timestamp, isFavorite: false });
            // Keep history to a reasonable size, e.g., last 50 scans
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            localStorage.setItem('qr_history', JSON.stringify(history));
            renderHistory(); // Re-render history if currently in history section
        }

        function loadHistory() {
            return JSON.parse(localStorage.getItem('qr_history') || '[]');
        }

        function renderHistory() {
            historyListUl.innerHTML = ''; // Clear current list
            selectedHistoryIndices.clear(); // Clear selected items
            updateDeleteSelectedButtonState(); // Update button state

            let history = loadHistory();

            // Apply favorite filter if checkbox is checked
            if (showFavoritesCheckbox.checked) {
                history = history.filter(item => item.isFavorite);
                if (history.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = translations[currentLanguage]['noFavoriteItems'];
                    historyListUl.appendChild(li);
                    clearHistoryButton.classList.add('hidden');
                    deleteSelectedHistoryButton.classList.add('hidden');
                    return;
                }
            }


            if (history.length === 0 && !showFavoritesCheckbox.checked) {
                const li = document.createElement('li');
                li.textContent = translations[currentLanguage]['noScanHistory'];
                historyListUl.appendChild(li);
                clearHistoryButton.classList.add('hidden');
                deleteSelectedHistoryButton.classList.add('hidden');
                return;
            }

            clearHistoryButton.classList.remove('hidden'); // Always show clear all if there's history
            history.forEach((item, index) => {
                const li = document.createElement('li');

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = index;
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedHistoryIndices.add(index);
                    } else {
                        selectedHistoryIndices.delete(index);
                    }
                    updateDeleteSelectedButtonState();
                });

                const textContent = document.createElement('span');
                textContent.className = 'history-text-content';
                textContent.innerHTML = `<strong>${item.timestamp}:</strong> ${item.data.substring(0, 50)}${item.data.length > 50 ? '...' : ''}`;
                textContent.addEventListener('click', () => {
                    handleScannedData(item.data);
                    showSection('scannerSection'); // Go back to scanner to display
                });

                const favoriteButton = document.createElement('button');
                favoriteButton.className = `favorite-button ${item.isFavorite ? 'favorited' : ''}`;
                favoriteButton.textContent = '★'; // Star character
                favoriteButton.title = item.isFavorite ? translations[currentLanguage]['unfavorite'] : translations[currentLanguage]['favorite'];
                favoriteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent li click event from firing
                    toggleFavorite(index);
                });


                li.appendChild(checkbox);
                li.appendChild(textContent);
                li.appendChild(favoriteButton); // Add favorite button
                historyListUl.appendChild(li);
            });
            updateDeleteSelectedButtonState(); // Initial state after rendering
        }

        function toggleFavorite(index) {
            let history = loadHistory();
            if (history[index]) {
                history[index].isFavorite = !history[index].isFavorite;
                localStorage.setItem('qr_history', JSON.stringify(history));
                renderHistory(); // Re-render to update star color and potentially filter
            }
        }

        function updateDeleteSelectedButtonState() {
            if (selectedHistoryIndices.size > 0) {
                deleteSelectedHistoryButton.classList.remove('hidden');
                deleteSelectedHistoryButton.textContent = `${translations[currentLanguage]['deleteSelected']} (${selectedHistoryIndices.size})`;
            } else {
                deleteSelectedHistoryButton.classList.add('hidden');
            }
        }

        // Custom confirmation modal for clearing history
        function showConfirmationModal(message, callback) {
            modalMessage.textContent = message;
            onConfirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }

        function hideConfirmationModal() {
            confirmationModal.classList.add('hidden');
            onConfirmCallback = null;
        }

        function clearHistory() {
            showConfirmationModal(translations[currentLanguage]['confirmDeleteAll'], () => {
                localStorage.removeItem('qr_history');
                renderHistory();
            });
        }

        function deleteSelectedHistory() {
            if (selectedHistoryIndices.size === 0) {
                showConfirmationModal(translations[currentLanguage]['noItemSelected'], () => {});
                return;
            }

            showConfirmationModal(translations[currentLanguage]['confirmDeleteSelected'].replace('{count}', selectedHistoryIndices.size), () => {
                let history = loadHistory();
                // Filter out selected items. Iterate in reverse to avoid index issues.
                const indicesToDelete = Array.from(selectedHistoryIndices).sort((a, b) => b - a);
                indicesToDelete.forEach(index => {
                    history.splice(index, 1);
                });
                localStorage.setItem('qr_history', JSON.stringify(history));
                renderHistory(); // Re-render history after deletion
            });
        }

        // --- Dark Mode Logic ---
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            localStorage.setItem('darkMode', isDarkMode); // Save preference
            darkModeToggle.textContent = isDarkMode ? translations[currentLanguage]['lightModeToggle'] : translations[currentLanguage]['darkModeToggle'];
        }

        // Apply dark mode preference on load
        function applyDarkModePreference() {
            const savedMode = localStorage.getItem('darkMode');
            if (savedMode === 'true') {
                document.body.classList.add('dark');
                darkModeToggle.textContent = translations[currentLanguage]['lightModeToggle'];
            } else {
                document.body.classList.remove('dark');
                darkModeToggle.textContent = translations[currentLanguage]['darkModeToggle'];
            }
        }

        // --- Flashlight Logic ---
        async function toggleFlashlight() {
            if (!currentTrack) {
                errorMessageDiv.textContent = translations[currentLanguage]['noCameraActiveFlashlight'];
                errorMessageDiv.classList.remove('hidden');
                return;
            }

            try {
                const capabilities = currentTrack.getCapabilities();
                if (!capabilities.torch) {
                    errorMessageDiv.textContent = translations[currentLanguage]['noFlashlightSupport'];
                    errorMessageDiv.classList.remove('hidden');
                    return;
                }

                const isTorchOn = currentTrack.getSettings().torch || false;
                await currentTrack.applyConstraints({
                    advanced: [{ torch: !isTorchOn }]
                });
                flashlightButton.textContent = !isTorchOn ? translations[currentLanguage]['flashlightOff'] : translations[currentLanguage]['flashlightOn'];
            } catch (err) {
                console.error("Error toggling flashlight:", err);
                errorMessageDiv.textContent = `${translations[currentLanguage]['unknownCameraError']} ${err.message}`;
                errorMessageDiv.classList.remove('hidden');
            }
        }


        // --- Event Listeners ---
        startQrScanButton.addEventListener('click', () => startScanner('qr')); // Start QR scan
        startBarcodeScanButton.addEventListener('click', () => startScanner('barcode')); // Start Barcode scan
        stopButton.addEventListener('click', stopScanner);
        uploadButton.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', scanFromImage);
        explainButton.addEventListener('click', explainWithGemini);
        flashlightButton.addEventListener('click', toggleFlashlight);

        // Navigation button listeners
        showScannerButton.addEventListener('click', () => showSection('scannerSection'));
        // showGeneratorButton.addEventListener('click', () => showSection('generatorSection')); // Generator button listener removed
        showHistoryButton.addEventListener('click', () => showSection('historySection'));
        darkModeToggle.addEventListener('click', toggleDarkMode);

        // Language selector listener
        languageSelect.addEventListener('change', (e) => {
            setLanguage(e.target.value);
            applyDarkModePreference(); // Re-apply dark mode text after language change
        });

        // History clear and delete selected buttons
        clearHistoryButton.addEventListener('click', clearHistory);
        deleteSelectedHistoryButton.addEventListener('click', deleteSelectedHistory);
        showFavoritesCheckbox.addEventListener('change', renderHistory); // Listener for favorite filter

        // Confirmation modal buttons
        confirmYesButton.addEventListener('click', () => {
            if (onConfirmCallback) {
                onConfirmCallback();
            }
            hideConfirmationModal();
        });

        confirmNoButton.addEventListener('click', () => {
            hideConfirmationModal();
        });

        // --- Initial Load ---
        window.onload = () => {
            // Set initial language from localStorage or default
            languageSelect.value = currentLanguage;
            setLanguage(currentLanguage);
            applyDarkModePreference(); // Apply dark mode preference
            showSection('scannerSection'); // Show scanner section by default
            updateDynamicMessages(); // Ensure initial messages are translated
        };
    </script>
</body>
</html>
